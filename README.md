# Modern api

这是一个cms系统的后台， 使用nestjs 和 typeorm 开发, 使用swagger 进行接口文档管理.

## 代码风格

- 使用驼峰命名法，代码使用英文完成， 注释使用中文完成。
- 使用eslint 进行代码检查， 使用prettier 进行代码格式化。
- 使用swagger 进行接口文档管理。
- 使用jest 进行单元测试。

## 最近更新

### 2025-01-18

1. **Creation模块开发完成**
   - 实现了完整的创作内容管理系统
   - 支持作品的创建、编辑、删除、查看功能
   - 实现了创作广场功能，支持作品公开展示
   - 添加了社交互动功能：点赞、喜欢、收藏
   - 实现了用户收藏管理功能

2. **Coze AI服务集成**
   - 创建了CozeService服务类，封装所有Coze API调用
   - 实现了自动令牌管理和缓存机制
   - 支持文件上传到Coze平台
   - 支持运行Coze工作流进行AI图片生成
   - 实现了异步任务状态查询功能
   - 添加了完整的错误处理和重试机制

3. **核心功能特点**
   - **作品管理**：支持标题、提示词、图片数组的完整管理
   - **权限控制**：严格的权限验证，确保只有创建者可以编辑自己的作品
   - **广场展示**：支持作品公开/私有状态切换
   - **社交互动**：点赞、收藏功能，防止恶意操作
   - **数据完整性**：防重复收藏，级联删除相关数据
   - **AI创作**：集成Coze AI服务，支持AI图片生成

4. **技术实现亮点**
   - 使用TypeORM实现复杂的数据关系（一对多、多对多）
   - 实现了灵活的权限控制系统
   - 完善的数据验证和错误处理
   - 支持复杂查询条件和分页排序
   - 完整的单元测试覆盖
   - HTTP客户端自动令牌管理
   - 请求和响应拦截器用于调试

5. **数据模型设计**
   - **Creation实体**：作品主表，包含标题、提示词、图片、统计数据
   - **UserCollection实体**：用户收藏中间表，防重复收藏
   - 严格的外键约束和数据一致性保证

6. **Coze API集成**
   - **接口定义**：完整的TypeScript接口定义
   - **服务封装**：CozeService类封装所有API调用
   - **控制器集成**：在CreationController中添加Coze相关接口
   - **环境配置**：支持通过环境变量配置Coze服务
   - **错误处理**：统一的错误处理和用户友好的错误信息

7. 文件模块
    - 使用七牛云相关服务， 对应api 文档 https://developer.qiniu.com/kodo/1312/upload
    - 相关配置放在.env.local 文件中
    - 实现了文件上传、删除、获取列表功能
    - 文件上传需要和用户关联上， 需要知道是哪一个用户上传的，删除的。

### 2024-01-17

1. 优化了系统配置
   - 添加了全局路由前缀 `/api/v1`
   - 优化了日志中间件，现在可以记录请求耗时
   - 完善了请求日志记录功能
     - 记录请求方法
     - 记录请求路径
     - 记录响应状态码
     - 记录请求处理时间

2. 完善了角色权限控制
   - 实现了角色守卫（RolesGuard）
   - 添加了角色装饰器的类型定义
   - 优化了模块间的依赖关系

### 2024-01-16

1. 完善了用户模块的功能

   - 实现了完整的CRUD接口
   - 添加了分页、排序和筛选功能
   - 实现了与角色的多对多关联
   - 添加了JWT认证和角色授权
   - 完善了单元测试

2. 统一了响应格式

   - 添加了统一的分页响应接口
   - 实现了统一的错误处理

3. 完善了权限控制

   - 添加了JWT认证守卫
   - 添加了角色守卫
   - 实现了公共路由装饰器
   - 实现了角色装饰器

4. 规范了项目结构
   - 按照模块化组织代码
   - 分离了DTO、实体和接口定义
   - 统一了命名规范和代码风格

### 2025-01-21

完成了目标模块的开发：

1. 实现了目标管理功能
   - 创建了Target和Task实体
   - 实现了目标的CRUD操作
   - 实现了任务与目标的关联
   - 添加了目标进度自动计算功能

2. 核心功能特点
   - 目标进度自动计算：基于任务完成时间计算
   - 完成百分比实时更新
   - 支持多任务关联
   - 完整的单元测试覆盖

3. 技术要点
   - 使用TypeORM实现一对多关联
   - 实现了自动计算目标进度的业务逻辑
   - 添加了完整的API文档
   - 实现了JWT认证保护

4. 代码质量保证
   - 遵循SOLID原则
   - 完整的单元测试
   - 使用DTO进行数据验证
   - 统一的错误处理

### 2025-01-22

1. userAction模块实体已从MikroORM风格迁移为TypeORM风格：
   - 主键改为自增ID（number类型）。
   - 其余字段类型和注释保持一致。
   - 统一使用TypeORM的@Entity、@PrimaryGeneratedColumn、@Column装饰器。

## API功能

项目是分模块开发的， 每个模块都有自己的controller, service, entity, dto, interface, module, test。和对应的单元测试。 可以参考src/user 目录下的文件，做新的模块开发。

- 用户管理
  - 用户列表
    - 分页
    - 排序
    - 筛选， 可以让用户自己定义筛选条件
  - 用户详情
    - 用户信息
  - 用户创建
    - 用户名称
    - 用户邮箱
    - 用户密码
    - 用户角色
    - 用户状态
    - 用户头像（需要调用文件上传接口）
    - 用户备注
    - 用户角色， 一个用户有多个角色， 一个角色有多个用户
  - 用户更新
  - 用户删除
- 角色管理
  - 角色列表
  - 角色详情
  - 角色创建
  - 角色更新
  - 角色删除
- 权限管理
  - 权限列表
  - 权限详情
  - 权限创建
    - 权限名称
    - 权限描述
    - 权限类型
    - 权限状态
    - 权限码
  - 权限更新
  - 权限删除
- 创作管理
  - 作品管理
    - 作品列表（支持分页、排序、筛选）
    - 作品详情
    - 作品创建（标题、提示词、图片数组）
    - 作品更新
    - 作品删除
    - 作品公开/私有状态切换
  - 创作广场
    - 公开作品展示
    - 作品互动（点赞、取消点赞）
  - 收藏管理
    - 收藏作品
    - 取消收藏
    - 用户收藏列表
  - AI创作（Coze集成）
    - AI图片生成
    - 工作流运行
    - 文件上传
    - 任务状态查询
- 菜单管理
- 日志管理
- 文件管理

- 系统配置

## 项目结构

src/
├── core/                # 核心模块目录
│   ├── guards/         # 全局守卫
│   ├── interceptors/   # 全局拦截器
│   ├── filters/        # 全局过滤器
│   └── services/       # 核心服务
│       └── redis/      # Redis 服务
├── shared/             # 共享模块目录
│   ├── constants/      # 常量定义
│   ├── interfaces/     # 接口定义
│   └── utils/         # 工具函数
└── modules/           # 业务模块目录
    ├── auth/          # 认证模块
    ├── user/          # 用户模块
    ├── creation/      # 创作模块
    └── ...

test/ # 测试目录
├── e2e/ # 端到端测试
└── unit/ # 单元测试

├── .env # 环境变量
├── .env.development # 开发环境变量
├── .env.production # 生产环境变量
├── .gitignore
├── nest-cli.json
├── package.json
├── README.md
├── tsconfig.json
└── tsconfig.build.json

## 技术栈

- nestjs
- typeorm
- swagger
- mysql
- jwt
- bcrypt
- multer
- axios (Coze API调用)
- form-data (文件上传)

## 全局接口返回规范

- 所有返回列表数据的接口，必须统一使用标准结构 `ListResponse<T>`。
- 结构定义见：`src/models/list-response.model.ts`
- 结构如下：

```typescript
export interface ListResponse<T> {
  total: number; // 总条数
  page: number; // 当前页码
  pageSize: number; // 每页条数
  list: T[]; // 列表数据
}
```

- 所有Service和Controller返回列表时，均需严格遵循此结构。
